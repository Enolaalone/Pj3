{% extends "segmentation/base.html" %}
{% block title %}图表展示{% endblock %}
{% block head_extra %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}
{% block content %}
<div class="card mb-3">
    <div class="card-body">
        <form class="row g-3" method="get">
            <div class="col-md-2">
                <label class="form-label">Cluster</label>
                <input type="text" class="form-control" name="cluster" value="{{ filters.cluster }}">
            </div>
            <div class="col-md-2">
                <label class="form-label">品类</label>
                <input type="text" class="form-control" name="category" value="{{ filters.category }}">
            </div>
            <div class="col-md-2">
                <label class="form-label">渠道</label>
                <input type="text" class="form-control" name="channel" value="{{ filters.channel }}">
            </div>
            <div class="col-md-3">
                <label class="form-label">起始时间 (YYYY-MM-DD)</label>
                <input type="text" class="form-control" name="date_from" value="{{ filters.date_from }}">
            </div>
            <div class="col-md-3">
                <label class="form-label">结束时间 (YYYY-MM-DD)</label>
                <input type="text" class="form-control" name="date_to" value="{{ filters.date_to }}">
            </div>
            <div class="col-12 d-flex gap-2">
                <button class="btn btn-primary" type="submit">应用筛选</button>
                <a class="btn btn-outline-light" href="{% url 'segmentation:charts' %}">重置</a>
            </div>
        </form>
    </div>
    {% if filters.cluster or filters.category or filters.channel or filters.date_from or filters.date_to %}
    <div class="card-footer text-secondary">
        当前筛选：
        {% if filters.cluster %}Cluster={{ filters.cluster }} {% endif %}
        {% if filters.category %}品类={{ filters.category }} {% endif %}
        {% if filters.channel %}渠道={{ filters.channel }} {% endif %}
        {% if filters.date_from %}起={{ filters.date_from }} {% endif %}
        {% if filters.date_to %}止={{ filters.date_to }}{% endif %}
    </div>
    {% endif %}
</div>
<div class="row g-3 mb-3">
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-body">
                <h6 class="card-title">Cluster 总金额 / 订单数</h6>
                <canvas id="barChart" height="200"></canvas>
            </div>
        </div>
    </div>
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-body">
                <h6 class="card-title">聚类中心雷达图</h6>
                <canvas id="radarChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>
{% if not chart_data.cluster_means %}
<p class="text-warning">暂无图表数据，请先上传并分群。</p>
{% endif %}
{{ chart_data|json_script:"chart-data" }}
{% endblock %}
{% block body_extra %}
<script>
(() => {
    const el = document.getElementById("chart-data");
    if (!el) return;
    const data = JSON.parse(el.textContent || "{}");
    const means = data.cluster_means || [];
    if (!means.length) return;
    const labels = means.map(m => "Cluster " + m.cluster_id);
    const totalAmount = means.map(m => m.total_amount);
    const orderCount = means.map(m => m.order_count);
    const radarLabels = ["total_amount", "order_count", "avg_amount", "promo_ratio", "refund_ratio", "recency_days"];
    const radarDatasets = means.map((m, idx) => ({
        label: "Cluster " + m.cluster_id,
        data: radarLabels.map(key => m[key] || 0),
        fill: true,
        backgroundColor: `rgba(${80 + idx*40}, ${160 - idx*20}, 255, 0.25)`,
        borderColor: `rgba(${80 + idx*40}, ${160 - idx*20}, 255, 0.9)`
    }));
    const axisColor = "#c9d1d9";

    const barCtx = document.getElementById("barChart");
    if (barCtx) {
        new Chart(barCtx, {
            type: "bar",
            data: {
                labels,
                datasets: [
                    { label: "总金额", data: totalAmount, backgroundColor: "rgba(56, 189, 248, 0.7)" },
                    { label: "订单数", data: orderCount, backgroundColor: "rgba(251, 146, 60, 0.7)" },
                ]
            },
            options: {
                responsive: true,
                scales: { y: { beginAtZero: true, ticks: { color: axisColor } }, x: { ticks: { color: axisColor } } },
                plugins: { legend: { labels: { color: axisColor } } }
            }
        });
    }

    const radarCtx = document.getElementById("radarChart");
    if (radarCtx) {
        new Chart(radarCtx, {
            type: "radar",
            data: { labels: radarLabels, datasets: radarDatasets },
            options: {
                responsive: true,
                elements: { line: { borderWidth: 2 } },
                plugins: { legend: { labels: { color: axisColor } } },
                scales: {
                    r: {
                        angleLines: { color: "#30363d" },
                        grid: { color: "#30363d" },
                        pointLabels: { color: axisColor },
                        ticks: { backdropColor: "transparent", color: axisColor }
                    }
                }
            }
        });
    }
})();
</script>
{% endblock %}

