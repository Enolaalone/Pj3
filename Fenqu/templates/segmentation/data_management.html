{% extends "base.html" %}
{% block title %}数据管理{% endblock %}
{% block content %}
<div class="page-header">
  <div class="d-flex justify-content-between align-items-center">
    <div>
      <h2><i class="bi bi-database"></i> 数据管理</h2>
      <p class="text-muted mb-0">上传CSV文件或导入示例数据进行用户分群分析</p>
    </div>
    <form method="post" class="d-inline">
      {% csrf_token %}
      <button class="btn btn-success" name="sample" value="1">
        <i class="bi bi-download"></i> 导入示例数据
      </button>
    </form>
  </div>
</div>

<div class="card mb-4">
  <div class="card-body">
    <h5 class="card-title"><i class="bi bi-upload"></i> 上传CSV文件</h5>
    <form method="post" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="row g-3 align-items-end">
        <div class="col-md-8">
          <label for="{{ upload_form.file.id_for_label }}" class="form-label">选择CSV文件</label>
          {{ upload_form.file }}
          <div class="form-text">支持包含 user_id, age, gender, region, last_purchase_date, purchase_count, total_amount, last_channel, last_login_date 字段的CSV文件</div>
        </div>
        <div class="col-md-4">
          <button type="submit" class="btn btn-primary w-100" name="upload" value="1">
            <i class="bi bi-cloud-upload"></i> 上传并导入
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<div class="row mb-4">
  <div class="col-md-3">
    <div class="stat-card text-center">
      <div class="stat-icon text-primary">
        <i class="bi bi-people"></i>
      </div>
      <h3 class="mt-3 mb-1">{{ stats.user_count }}</h3>
      <p class="text-muted mb-0">用户总数</p>
    </div>
  </div>
  <div class="col-md-3">
    <div class="stat-card text-center">
      <div class="stat-icon text-info">
        <i class="bi bi-calendar-heart"></i>
      </div>
      <h3 class="mt-3 mb-1">{{ stats.avg_age|floatformat:1 }}</h3>
      <p class="text-muted mb-0">平均年龄</p>
    </div>
  </div>
  <div class="col-md-3">
    <div class="stat-card text-center">
      <div class="stat-icon text-success">
        <i class="bi bi-cart-check"></i>
      </div>
      <h3 class="mt-3 mb-1">{{ stats.avg_purchase_count|floatformat:1 }}</h3>
      <p class="text-muted mb-0">平均购买次数</p>
    </div>
  </div>
  <div class="col-md-3">
    <div class="stat-card text-center">
      <div class="stat-icon text-warning">
        <i class="bi bi-currency-dollar"></i>
      </div>
      <h3 class="mt-3 mb-1">{{ stats.total_amount|floatformat:0 }}</h3>
      <p class="text-muted mb-0">总消费金额</p>
    </div>
  </div>
</div>

<div class="row mb-4">
  <div class="col-md-4">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title"><i class="bi bi-gender-ambiguous"></i> 性别分布</h5>
        <div class="chart-container" style="height: 250px;">
          <canvas id="genderChart"></canvas>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title"><i class="bi bi-geo-alt"></i> 地区分布</h5>
        <div class="chart-container" style="height: 250px;">
          <canvas id="regionChart"></canvas>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-4">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title"><i class="bi bi-broadcast"></i> 渠道分布（Top 5）</h5>
        <div class="chart-container" style="height: 250px;">
          <canvas id="channelChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="card">
  <div class="card-body">
    <h5 class="card-title"><i class="bi bi-table"></i> 数据预览（前20条）</h5>
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>用户ID</th>
            <th>年龄</th>
            <th>性别</th>
            <th>地区</th>
            <th>最后购买</th>
            <th>购买次数</th>
            <th>总金额</th>
            <th>渠道</th>
            <th>最后登录</th>
          </tr>
        </thead>
        <tbody>
          {% for u in preview %}
          <tr>
            <td><strong>{{ u.user_id }}</strong></td>
            <td>{{ u.age }}</td>
            <td><span class="badge bg-secondary">{{ u.gender }}</span></td>
            <td>{{ u.region }}</td>
            <td>{{ u.last_purchase_date|date:"Y-m-d" }}</td>
            <td>{{ u.purchase_count }}</td>
            <td>{{ u.total_amount|floatformat:2 }}</td>
            <td><span class="badge bg-info">{{ u.last_channel }}</span></td>
            <td>{{ u.last_login_date|date:"Y-m-d" }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="9" class="text-center text-muted">暂无数据，请先上传或导入数据</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  // 性别分布
  const genderData = {
    labels: [{% for item in gender_dist %}"{{ item.gender }}"{% if not forloop.last %},{% endif %}{% endfor %}],
    datasets: [{
      data: [{% for item in gender_dist %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
      backgroundColor: ['#667eea', '#f093fb', '#43e97b']
    }]
  };
  const genderCtx = document.getElementById('genderChart');
  if (genderCtx && genderData.labels.length > 0) {
    new Chart(genderCtx, {
      type: 'pie',
      data: genderData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'bottom' } }
      }
    });
  }

  // 地区分布
  const regionData = {
    labels: [{% for item in region_dist %}"{{ item.region }}"{% if not forloop.last %},{% endif %}{% endfor %}],
    datasets: [{
      label: '用户数',
      data: [{% for item in region_dist %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
      backgroundColor: 'rgba(102, 126, 234, 0.8)',
      borderColor: 'rgba(102, 126, 234, 1)',
      borderWidth: 2
    }]
  };
  const regionCtx = document.getElementById('regionChart');
  if (regionCtx && regionData.labels.length > 0) {
    new Chart(regionCtx, {
      type: 'bar',
      data: regionData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
      }
    });
  }

  // 渠道分布
  const channelData = {
    labels: [{% for item in channel_dist %}"{{ item.last_channel }}"{% if not forloop.last %},{% endif %}{% endfor %}],
    datasets: [{
      data: [{% for item in channel_dist %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
      backgroundColor: ['#667eea', '#43e97b', '#f093fb', '#4facfe', '#f5576c']
    }]
  };
  const channelCtx = document.getElementById('channelChart');
  if (channelCtx && channelData.labels.length > 0) {
    new Chart(channelCtx, {
      type: 'doughnut',
      data: channelData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: { legend: { position: 'bottom' } }
      }
    });
  }
</script>
{% endblock %}

