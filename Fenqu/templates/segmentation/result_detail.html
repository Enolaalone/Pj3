{% extends "base.html" %}
{% block title %}结果详情{% endblock %}
{% block content %}
<div class="page-header">
  <div class="d-flex justify-content-between align-items-start">
    <div>
      <h2><i class="bi bi-list-check"></i> {{ task.task_name }}</h2>
      <p class="text-muted mb-2">
        <span class="badge bg-{% if task.task_type == 'rule' %}primary{% elif task.task_type == 'rfm' %}success{% else %}warning{% endif %} me-2">
          {{ task.get_task_type_display }}
        </span>
        创建时间：{{ task.created_at|date:"Y-m-d H:i:s" }}
      </p>
      <p class="mb-0">
        <strong>配置参数：</strong>
        <code class="bg-light p-2 rounded d-inline-block">{{ task.config|safe }}</code>
      </p>
    </div>
    <a href="{% url 'segmentation:results_list' %}" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> 返回列表
    </a>
  </div>
</div>

<div class="row mb-4">
  <div class="col-md-4">
    <div class="stat-card text-center">
      <div class="stat-icon text-primary">
        <i class="bi bi-people"></i>
      </div>
      <h3 class="mt-3 mb-1">{{ total_results }}</h3>
      <p class="text-muted mb-0">分群用户数</p>
    </div>
  </div>
  <div class="col-md-4">
    <div class="stat-card text-center">
      <div class="stat-icon text-success">
        <i class="bi bi-diagram-3"></i>
      </div>
      <h3 class="mt-3 mb-1">{{ segment_dist|length }}</h3>
      <p class="text-muted mb-0">分群数量</p>
    </div>
  </div>
  <div class="col-md-4">
    <div class="stat-card text-center">
      <div class="stat-icon text-info">
        <i class="bi bi-percent"></i>
      </div>
      <h3 class="mt-3 mb-1">
        {% if total_results > 0 %}
          {{ results|length|floatformat:0 }}/{{ total_results }}
        {% else %}
          0
        {% endif %}
      </h3>
      <p class="text-muted mb-0">当前显示/总数</p>
    </div>
  </div>
</div>

<div class="row mb-4">
  <div class="col-md-6">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title"><i class="bi bi-pie-chart"></i> 分群分布</h5>
        <div class="chart-container">
          <canvas id="segmentChart"></canvas>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title"><i class="bi bi-bar-chart"></i> 分群统计</h5>
        <div class="chart-container">
          <canvas id="segmentBarChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="card">
  <div class="card-body">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="card-title mb-0"><i class="bi bi-table"></i> 分群结果详情</h5>
      <a href="?export=csv" class="btn btn-sm btn-outline-primary">
        <i class="bi bi-download"></i> 导出CSV
      </a>
    </div>
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>用户ID</th>
            <th>年龄</th>
            <th>性别</th>
            <th>地区</th>
            <th>购买次数</th>
            <th>总金额</th>
            <th>分群标签</th>
            <th>分群值</th>
            {% if task.task_type == 'rfm' %}
            <th>RFM得分</th>
            {% endif %}
          </tr>
        </thead>
        <tbody>
          {% for r in results %}
          <tr>
            <td><strong>{{ r.user.user_id }}</strong></td>
            <td>{{ r.user.age }}</td>
            <td><span class="badge bg-secondary">{{ r.user.gender }}</span></td>
            <td>{{ r.user.region }}</td>
            <td>{{ r.user.purchase_count }}</td>
            <td>{{ r.user.total_amount|floatformat:2 }}</td>
            <td><span class="badge bg-info">{{ r.segment_label }}</span></td>
            <td><span class="badge bg-{% if task.task_type == 'rfm' %}success{% elif task.task_type == 'cluster' %}warning{% else %}primary{% endif %}">{{ r.segment_value }}</span></td>
            {% if task.task_type == 'rfm' %}
            <td>
              {% if r.metadata %}
                R{{ r.metadata.recency_score|default:'' }} F{{ r.metadata.frequency_score|default:'' }} M{{ r.metadata.monetary_score|default:'' }}
              {% endif %}
            </td>
            {% endif %}
          </tr>
          {% empty %}
          <tr><td colspan="{% if task.task_type == 'rfm' %}9{% else %}8{% endif %}" class="text-center text-muted">暂无结果</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% if total_results > results|length %}
    <div class="text-center mt-3">
      <p class="text-muted">仅显示前 {{ results|length }} 条，共 {{ total_results }} 条结果</p>
    </div>
    {% endif %}
  </div>
</div>

<script>
  // 分群分布饼图
  const segmentData = {
    labels: [{% for item in segment_dist %}"{{ item.segment_value }}"{% if not forloop.last %},{% endif %}{% endfor %}],
    datasets: [{
      data: [{% for item in segment_dist %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
      backgroundColor: [
        '#667eea', '#43e97b', '#f093fb', '#4facfe', '#f5576c',
        '#fa709a', '#fee140', '#30cfd0', '#a8edea', '#fed6e3'
      ]
    }]
  };
  const segmentCtx = document.getElementById('segmentChart');
  if (segmentCtx && segmentData.labels.length > 0) {
    new Chart(segmentCtx, {
      type: 'pie',
      data: segmentData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom' },
          tooltip: {
            callbacks: {
              label: function(context) {
                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                const percentage = ((context.parsed / total) * 100).toFixed(1);
                return context.label + ': ' + context.parsed + ' (' + percentage + '%)';
              }
            }
          }
        }
      }
    });
  }

  // 分群统计柱状图
  const segmentBarData = {
    labels: [{% for item in segment_dist %}"{{ item.segment_value }}"{% if not forloop.last %},{% endif %}{% endfor %}],
    datasets: [{
      label: '用户数',
      data: [{% for item in segment_dist %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
      backgroundColor: 'rgba(102, 126, 234, 0.8)',
      borderColor: 'rgba(102, 126, 234, 1)',
      borderWidth: 2
    }]
  };
  const segmentBarCtx = document.getElementById('segmentBarChart');
  if (segmentBarCtx && segmentBarData.labels.length > 0) {
    new Chart(segmentBarCtx, {
      type: 'bar',
      data: segmentBarData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false }
        },
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  }
</script>
{% endblock %}

