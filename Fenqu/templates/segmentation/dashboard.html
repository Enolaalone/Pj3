{% extends "base.html" %}
{% block title %}仪表盘{% endblock %}
{% block content %}
<div class="page-header">
  <h2><i class="bi bi-speedometer2"></i> 数据概览</h2>
  <p class="text-muted mb-0">用户分群系统整体数据统计</p>
</div>

<div class="row mb-4">
  <div class="col-md-3">
    <div class="stat-card text-center">
      <div class="stat-icon text-primary">
        <i class="bi bi-people"></i>
      </div>
      <h3 class="mt-3 mb-1">{{ total_users }}</h3>
      <p class="text-muted mb-0">用户总数</p>
    </div>
  </div>
  <div class="col-md-3">
    <div class="stat-card text-center">
      <div class="stat-icon text-success">
        <i class="bi bi-list-task"></i>
      </div>
      <h3 class="mt-3 mb-1">{{ total_tasks }}</h3>
      <p class="text-muted mb-0">分群任务</p>
    </div>
  </div>
  <div class="col-md-3">
    <div class="stat-card text-center">
      <div class="stat-icon text-info">
        <i class="bi bi-calendar-heart"></i>
      </div>
      <h3 class="mt-3 mb-1">{{ avg_age }}</h3>
      <p class="text-muted mb-0">平均年龄</p>
    </div>
  </div>
  <div class="col-md-3">
    <div class="stat-card text-center">
      <div class="stat-icon text-warning">
        <i class="bi bi-currency-dollar"></i>
      </div>
      <h3 class="mt-3 mb-1">{{ total_amount_sum|floatformat:0 }}</h3>
      <p class="text-muted mb-0">总消费金额</p>
    </div>
  </div>
</div>

<div class="row mb-4">
  <div class="col-md-6">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title"><i class="bi bi-pie-chart"></i> 分群类型分布</h5>
        <div class="chart-container">
          <canvas id="taskTypeChart"></canvas>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title"><i class="bi bi-gender-ambiguous"></i> 用户性别分布</h5>
        <div class="chart-container">
          <canvas id="genderChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="row mb-4">
  <div class="col-md-6">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title"><i class="bi bi-geo-alt"></i> 地区分布（Top 5）</h5>
        <div class="chart-container">
          <canvas id="regionChart"></canvas>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-6">
    <div class="card">
      <div class="card-body">
        <h5 class="card-title"><i class="bi bi-clock-history"></i> 最近任务</h5>
        <div class="list-group">
          {% for task in recent_tasks %}
          <a href="{% url 'segmentation:result_detail' task.id %}" class="list-group-item list-group-item-action">
            <div class="d-flex w-100 justify-content-between">
              <h6 class="mb-1">{{ task.task_name }}</h6>
              <small class="text-muted">{{ task.created_at|date:"m-d H:i" }}</small>
            </div>
            <p class="mb-1">
              <span class="badge bg-{% if task.task_type == 'rule' %}primary{% elif task.task_type == 'rfm' %}success{% else %}warning{% endif %}">
                {{ task.get_task_type_display }}
              </span>
            </p>
          </a>
          {% empty %}
          <div class="list-group-item text-center text-muted">暂无任务</div>
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // 分群类型分布饼图
  const taskTypeData = {
    labels: [{% for item in task_type_counts %}"{{ item.task_type }}"{% if not forloop.last %},{% endif %}{% endfor %}],
    datasets: [{
      data: [{% for item in task_type_counts %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
      backgroundColor: ['#667eea', '#43e97b', '#f093fb', '#4facfe', '#f5576c']
    }]
  };
  const taskTypeCtx = document.getElementById('taskTypeChart');
  if (taskTypeCtx) {
    new Chart(taskTypeCtx, {
      type: 'pie',
      data: taskTypeData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom' }
        }
      }
    });
  }

  // 性别分布饼图
  const genderData = {
    labels: [{% for item in gender_dist %}"{{ item.gender }}"{% if not forloop.last %},{% endif %}{% endfor %}],
    datasets: [{
      data: [{% for item in gender_dist %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
      backgroundColor: ['#667eea', '#f093fb', '#43e97b']
    }]
  };
  const genderCtx = document.getElementById('genderChart');
  if (genderCtx) {
    new Chart(genderCtx, {
      type: 'doughnut',
      data: genderData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom' }
        }
      }
    });
  }

  // 地区分布柱状图
  const regionData = {
    labels: [{% for item in region_dist %}"{{ item.region }}"{% if not forloop.last %},{% endif %}{% endfor %}],
    datasets: [{
      label: '用户数',
      data: [{% for item in region_dist %}{{ item.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
      backgroundColor: 'rgba(102, 126, 234, 0.8)',
      borderColor: 'rgba(102, 126, 234, 1)',
      borderWidth: 2
    }]
  };
  const regionCtx = document.getElementById('regionChart');
  if (regionCtx) {
    new Chart(regionCtx, {
      type: 'bar',
      data: regionData,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false }
        },
        scales: {
          y: { beginAtZero: true }
        }
      }
    });
  }
</script>
{% endblock %}

